<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellarion Studio | Company 3D Generator</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Manrope', 'Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    },
                    colors: {
                        background: '#030712',
                        surface: '#0b101b',
                        primary: { DEFAULT: '#2563eb', hover: '#1d4ed8' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    }
                }
            }
        };
    </script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        :root {
            --glass-bg: rgba(11, 16, 27, 0.85);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        body {
            background-color: #030712;
            background-image:
                radial-gradient(#475569 1px, transparent 1px),
                radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.12) 0%, transparent 45%),
                radial-gradient(circle at 100% 100%, rgba(14, 116, 144, 0.12) 0%, transparent 45%);
            background-size: 56px 56px, 100% 100%, 100% 100%;
            background-attachment: fixed;
            color: #e2e8f0;
            height: 100vh;
            overflow: hidden;
        }

        .glass {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .input-field {
            background: rgba(9, 14, 24, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #f8fafc;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-field:focus {
            border-color: rgba(37, 99, 235, 0.7);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
            outline: none;
        }

        .btn-modern {
            border: none !important;
            outline: none !important;
            box-shadow: 0 4px 20px -5px rgba(37, 99, 235, 0.45);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px -6px rgba(37, 99, 235, 0.55);
        }

        .back-button {
            width: 34px;
            height: 34px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(15, 23, 42, 0.85);
            color: #e2e8f0;
            transition: background 0.2s ease, transform 0.2s ease;
        }
        .back-button:hover {
            background: rgba(37, 99, 235, 0.45);
            transform: translateY(-1px);
        }

        .btn-loading {
            cursor: wait !important;
            opacity: 0.85;
        }
        .loading-dots {
            display: inline-flex;
            gap: 4px;
            margin-left: 6px;
        }
        .loading-dots span {
            width: 5px;
            height: 5px;
            border-radius: 9999px;
            background: rgba(255, 255, 255, 0.85);
            animation: dotPulse 1s infinite ease-in-out;
        }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes dotPulse {
            0%, 80%, 100% { opacity: 0.25; transform: translateY(0); }
            40% { opacity: 1; transform: translateY(-2px); }
        }

        #viewer-wrapper {
            background: radial-gradient(circle at top, rgba(37, 99, 235, 0.12), transparent 55%) #050816;
            border-left: 1px solid rgba(255, 255, 255, 0.05);
        }

        .viewer-toolbar {
            min-width: 180px;
            background: rgba(8, 11, 19, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(18px);
        }
        .bg-option {
            width: 28px;
            height: 28px;
            border-radius: 9px;
            border: 2px solid transparent;
            transition: transform 0.15s ease, border 0.15s ease;
            outline: none;
        }
        .bg-option:hover {
            transform: translateY(-2px);
        }
        .bg-option.active {
            border-color: rgba(255, 255, 255, 0.75);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.35);
        }

        model-viewer {
            width: 100%;
            height: 100%;
            --poster-color: transparent;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden selection:bg-blue-500/30">
    <aside class="w-full md:w-[420px] flex flex-col glass z-20 border-r border-white/5 h-full shadow-2xl">
        <div class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-black/30 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <button type="button" class="back-button" onclick="goBack()" aria-label="Go back">
                    <i class="fa-solid fa-arrow-left"></i>
                </button>
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="fa-solid fa-building text-white text-sm"></i>
                </div>
                <h1 class="font-bold text-lg tracking-tight text-white">Brand Studio</h1>
            </div>
            <div class="flex items-center gap-3">
                <div class="text-right hidden sm:block">
                    <div id="navCompanyName" class="text-xs font-bold text-white">Partner</div>
                    <div class="text-[10px] text-blue-400">Company Portal</div>
                </div>
                <div class="w-8 h-8 rounded-full bg-slate-800 border border-white/10 flex items-center justify-center text-xs text-white font-bold shadow-inner">
                    <i class="fa-solid fa-user-tie"></i>
                </div>
            </div>
        </div>

        <section class="px-6 pt-5">
            <div class="glass border border-white/10 rounded-2xl p-4 bg-black/40">
                <div class="flex items-center justify-between text-[11px] text-slate-400 uppercase tracking-widest font-semibold mb-3">
                    <span>Account Snapshot</span>
                    <span class="text-blue-400" id="accountRole">Company</span>
                </div>
                <div class="space-y-3 text-slate-200 text-xs">
                    <div class="flex items-center justify-between">
                        <span class="text-slate-400">Primary Contact</span>
                        <span class="font-semibold" id="accountName">Guest User</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-slate-400">User ID</span>
                        <span class="font-mono text-[11px]" id="accountId">—</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-slate-400">Company Profile</span>
                        <span class="font-semibold" id="accountProfile">Not Linked</span>
                    </div>
                </div>
            </div>
        </section>

        <div id="settingsPanel" class="hidden bg-[#0b101b] border-b border-white/10 p-4 animate-[fadeIn_0.2s]">
            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-wider block mb-2">Meshy API Key</label>
            <div class="flex gap-2">
                <input type="password" id="apiKeyInput" class="w-full input-field rounded-lg px-3 py-2 text-xs" placeholder="sk-ms-...">
                <button onclick="saveSettings()" class="bg-blue-600 text-white px-3 rounded-lg text-xs font-bold btn-modern">Save</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6">
            <section id="step-upload" class="space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xs font-bold text-blue-300 uppercase tracking-widest">1. Source</h2>
                    <button onclick="toggleSettings()" class="text-[10px] text-slate-500 hover:text-white transition"><i class="fa-solid fa-key"></i> API Key</button>
                </div>
                <div id="dropZone" onclick="document.getElementById('fileInput').click()" class="group relative border-2 border-dashed border-slate-700 rounded-xl p-8 text-center hover:border-blue-500 hover:bg-blue-500/5 transition-all cursor-pointer bg-slate-900/50">
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                    <div id="uploadPrompt">
                        <div class="w-14 h-14 mx-auto mb-3 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center group-hover:scale-110 group-hover:border-blue-500/50 transition-transform shadow-xl">
                            <i class="fa-solid fa-cloud-arrow-up text-slate-400 group-hover:text-blue-400 text-lg"></i>
                        </div>
                        <p class="text-xs text-slate-300 font-bold">Upload hero product photography</p>
                    </div>
                    <div id="imagePreview" class="hidden absolute inset-0 bg-[#0b101b] z-10 p-2 rounded-xl">
                        <img id="previewImg" class="w-full h-full object-contain rounded-lg border border-white/5 bg-black" alt="Product preview">
                        <button onclick="resetUpload(event)" class="absolute top-2 right-2 w-8 h-8 bg-red-500 text-white rounded-lg flex items-center justify-center shadow-lg hover:bg-red-600 btn-modern transition-colors">
                            <i class="fa-solid fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            </section>

            <p class="text-[11px] leading-relaxed text-slate-500/80">
                Ideal inputs: centered product shots on plain backgrounds in PNG or JPG. Clean up assets in seconds with our <a href="remove_bg.html" class="text-blue-300 hover:text-blue-200 underline">background remover</a> before uploading.
            </p>

            <section id="step-config" class="space-y-4 opacity-50 pointer-events-none transition-opacity duration-300">
                <h2 class="text-xs font-bold text-blue-300 uppercase tracking-widest">2. Generation Parameters</h2>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] text-slate-400 block mb-1 font-bold">Art Style</label>
                        <select id="artStyle" class="w-full input-field rounded-lg px-2 py-2 text-xs font-medium cursor-pointer">
                            <option value="realistic">Realistic (PBR)</option>
                            <option value="cartoon">Stylized</option>
                            <option value="low-poly">Low Poly</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 block mb-1 font-bold">Poly Count</label>
                        <select id="polyCount" class="w-full input-field rounded-lg px-2 py-2 text-xs font-medium cursor-pointer">
                            <option value="high">High Detail</option>
                            <option value="medium" selected>Balanced</option>
                        </select>
                    </div>
                </div>
                <div class="space-y-3">
                    <input type="text" id="texturePrompt" placeholder="Texture prompt (e.g. polished walnut grain)" class="w-full input-field rounded-lg px-3 py-2 text-xs">
                    <input type="text" id="negativePrompt" placeholder="Avoid (e.g. harsh shadows)" class="w-full input-field rounded-lg px-3 py-2 text-xs">
                </div>
                <button id="btnGenerate" onclick="startGeneration()" class="btn-modern w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-xl text-sm font-semibold tracking-wide flex items-center justify-center gap-2 hover:brightness-110">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Generate 3D asset
                </button>
            </section>

            <div id="consoleSection" class="hidden space-y-2">
                <div id="consoleArea" class="glass p-3 rounded-lg border border-white/5 max-h-[110px] overflow-y-auto font-mono text-[10px] space-y-1 text-slate-400"></div>
                <div class="w-full bg-slate-800 rounded-full h-2.5 border border-white/5 overflow-hidden">
                    <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-500 h-2.5 rounded-full transition-all duration-500" style="width:0%"></div>
                </div>
                <div class="flex justify-between text-[9px] text-slate-500 uppercase font-bold">
                    <span>Processing</span>
                    <span id="progressText">0%</span>
                </div>
            </div>

            <section id="step-save" class="hidden pt-6 border-t border-white/10 animate-[fadeIn_0.4s] space-y-5">
                <div class="flex items-center gap-2 text-emerald-400 text-sm font-semibold">
                    <i class="fa-solid fa-circle-check"></i>
                    Model ready – document your catalog details below.
                </div>
                <div class="space-y-3">
                    <input type="text" id="modelName" placeholder="Product Name" class="w-full input-field rounded-lg px-3 py-2 text-xs font-semibold">
                    <textarea id="dbDesc" rows="2" placeholder="Short merchandising description" class="w-full input-field rounded-lg px-3 py-2 text-xs"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <select id="dbCategory" class="w-full input-field rounded-lg px-2 py-2 text-xs">
                        <option value="living-room">Living Room</option>
                        <option value="bedroom">Bedroom</option>
                        <option value="dining">Dining</option>
                        <option value="office">Office</option>
                        <option value="outdoor">Outdoor</option>
                        <option value="storage">Storage</option>
                        <option value="decor">Decor</option>
                        <option value="lighting">Lighting</option>
                    </select>
                    <select id="dbStyle" class="w-full input-field rounded-lg px-2 py-2 text-xs">
                        <option value="modern">Modern</option>
                        <option value="contemporary">Contemporary</option>
                        <option value="minimalist">Minimalist</option>
                        <option value="industrial">Industrial</option>
                        <option value="traditional">Traditional</option>
                        <option value="mid-century">Mid-Century</option>
                        <option value="bohemian">Bohemian</option>
                        <option value="scandinavian">Scandinavian</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="dbMsrp" placeholder="MSRP (USD)" class="input-field rounded-lg px-3 py-2 text-xs">
                    <input type="number" id="dbWholesale" placeholder="Wholesale Price" class="input-field rounded-lg px-3 py-2 text-xs">
                    <input type="number" id="dbPrice" placeholder="Marketplace Price" class="input-field rounded-lg px-3 py-2 text-xs">
                    <input type="text" id="dbSku" placeholder="SKU / Catalog Code" class="input-field rounded-lg px-3 py-2 text-xs">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="dbInventory" placeholder="Inventory (units)" class="input-field rounded-lg px-3 py-2 text-xs">
                    <input type="number" id="dbLeadTime" placeholder="Lead Time (days)" class="input-field rounded-lg px-3 py-2 text-xs">
                </div>
                <div class="space-y-3">
                    <textarea id="dbMaterials" rows="2" placeholder="Materials & composition" class="w-full input-field rounded-lg px-3 py-2 text-xs"></textarea>
                    <textarea id="dbFinishes" rows="2" placeholder="Finish options" class="w-full input-field rounded-lg px-3 py-2 text-xs"></textarea>
                </div>
                <div class="space-y-2">
                    <label for="companyProfileId" class="text-[10px] font-bold uppercase tracking-widest text-slate-400">Company Profile ID *</label>
                    <input type="number" id="companyProfileId" placeholder="Auto-filled from your account" class="w-full input-field rounded-lg px-3 py-2 text-xs" readonly>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveToCompanyLibrary(event)" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded-xl text-xs font-semibold btn-modern flex items-center justify-center gap-2">
                        <i class="fa-solid fa-database"></i> Save to company library
                    </button>
                    <button onclick="downloadModel()" class="w-1/3 bg-slate-700 hover:bg-slate-600 text-white py-2.5 rounded-xl text-xs font-semibold btn-modern flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> Download
                    </button>
                </div>
            </section>
        </div>
    </aside>

    <main class="flex-1 relative">
        <div id="canvas-placeholder" class="absolute inset-0 flex flex-col items-center justify-center z-10 pointer-events-none">
            <div class="text-center p-8 bg-slate-950/40 backdrop-blur-md rounded-3xl border border-white/10 shadow-2xl">
                <div class="relative inline-block mb-4">
                    <div class="absolute inset-0 bg-blue-500/30 blur-2xl rounded-full animate-pulse-slow"></div>
                    <i class="fa-solid fa-cubes text-6xl text-blue-100 relative z-10 animate-[float_4s_ease-in-out_infinite]"></i>
                </div>
                <h2 class="text-xl font-bold text-white mb-1">Company 3D Workspace</h2>
                <p class="text-slate-400 text-xs">Generate assets and attach merchandising data for Stellarion shoppers.</p>
            </div>
        </div>

        <div id="viewer-wrapper" class="w-full h-full opacity-0 transition-opacity duration-700 relative z-20">
            <model-viewer
                id="modelViewer"
                camera-controls
                auto-rotate
                shadow-intensity="1.5"
                shadow-softness="1"
                exposure="1.2"
                environment-image="neutral"
                ar
                class="w-full h-full"
                crossorigin="anonymous">
            </model-viewer>

            <div class="viewer-toolbar absolute top-6 right-6 px-4 py-3 rounded-2xl shadow-xl">
                <div class="text-[10px] font-semibold uppercase tracking-widest text-slate-400">Background</div>
                <div class="flex items-center gap-2 mt-2">
                    <button type="button" class="bg-option active" data-background="midnight" style="background:#0f172a" aria-label="Midnight"></button>
                    <button type="button" class="bg-option" data-background="studio" style="background:#f8fafc" aria-label="Studio"></button>
                </div>
            </div>

            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 glass px-4 py-2 rounded-full flex gap-4 border border-white/10 bg-black/40">
                <button onclick="toggleRotate()" class="text-white/70 hover:text-white transition"><i class="fa-solid fa-rotate"></i></button>
            </div>
        </div>
    </main>

    <div id="toastContainer" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <script>
        const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:3000' : window.location.origin;
        let currentUser = { id: null };
        let companyProfileFetchAttempted = false;
        let apiKey = localStorage.getItem('meshy_api_key') || '';
        let uploadedImageBase64 = null;
        let currentTaskId = null;
        let currentUrls = { glb: null, obj: null, proxy: null, thumbnail: null };
        let currentLocalPaths = {};
        const BACKGROUND_OPTIONS = {
            midnight: {
                wrapperBackground: 'radial-gradient(circle at top, rgba(37, 99, 235, 0.12), transparent 55%) #020617',
                viewerBackground: '#07152b',
                environment: 'neutral',
                exposure: 1.2
            },
            studio: {
                wrapperBackground: '#f8fafc',
                viewerBackground: '#f8fafc',
                environment: 'neutral',
                exposure: 1.0
            }
        };
        let activeBackground = 'midnight';
        let generateBtn;
        let generateBtnDefaultClass = '';
        let generateBtnDefaultHTML = '';

        document.addEventListener('DOMContentLoaded', () => {
            generateBtn = document.getElementById('btnGenerate');
            if (generateBtn) {
                generateBtnDefaultClass = generateBtn.className;
                generateBtnDefaultHTML = generateBtn.innerHTML;
            }
            initBackgroundPicker();
            setViewerBackground(activeBackground);

            hydrateAccountSummary();
            fetchCompanyProfileIfNeeded();

            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
            }

            document.getElementById('modelViewer').addEventListener('error', (event) => {
                if (!currentUrls.glb) {
                    event.preventDefault();
                }
            });
        });

        function goBack() {
            if (document.referrer && document.referrer !== window.location.href) {
                history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('hidden');
        }

        function getStoredAuthToken() {
            const tokenCandidates = [
                sessionStorage.getItem('authToken'),
                localStorage.getItem('authToken'),
                sessionStorage.getItem('token'),
                localStorage.getItem('token'),
                sessionStorage.getItem('companyToken'),
                localStorage.getItem('companyToken')
            ].filter(Boolean);

            const storedToken = tokenCandidates.find(Boolean);
            if (!storedToken) {
                return null;
            }
            return storedToken.startsWith('Bearer ') ? storedToken : `Bearer ${storedToken}`;
        }

        function resolveStoredCompanyUser() {
            const storageSources = [
                { storage: sessionStorage, keys: ['companyUser', 'user', 'company_context', 'companyProfilePayload'] },
                { storage: localStorage, keys: ['companyUser', 'user', 'company_context', 'companyProfilePayload'] }
            ];

            for (const { storage, keys } of storageSources) {
                if (!storage) {
                    continue;
                }
                for (const key of keys) {
                    const raw = storage.getItem(key);
                    if (!raw) {
                        continue;
                    }
                    try {
                        const parsed = JSON.parse(raw);
                        if (parsed && typeof parsed === 'object') {
                            return { data: parsed, source: `${key} (${storage === sessionStorage ? 'session' : 'local'})` };
                        }
                    } catch (error) {
                        // Ignore parse issues and continue scanning other keys
                    }
                }
            }

            const simpleProfileId = sessionStorage.getItem('companyProfileId') || localStorage.getItem('companyProfileId');
            const simpleUserId = sessionStorage.getItem('companyUserId') || localStorage.getItem('companyUserId');

            if (simpleProfileId || simpleUserId) {
                return {
                    data: {
                        id: simpleUserId ? Number.parseInt(simpleUserId, 10) || null : null,
                        companyProfileId: simpleProfileId ? Number.parseInt(simpleProfileId, 10) || null : null
                    },
                    source: 'simple-session'
                };
            }

            return null;
        }

        function hydrateAccountSummary() {
            const navNameEl = document.getElementById('navCompanyName');
            const accountNameEl = document.getElementById('accountName');
            const accountIdEl = document.getElementById('accountId');
            const accountProfileEl = document.getElementById('accountProfile');

            const storedContext = resolveStoredCompanyUser();
            let parsedUser = storedContext?.data || null;

            if (parsedUser && typeof parsedUser.user === 'object') {
                parsedUser = { ...parsedUser, ...parsedUser.user };
            }

            if (parsedUser && typeof parsedUser.company === 'object') {
                parsedUser = { ...parsedUser, ...parsedUser.company };
            }

            if (!parsedUser) {
                currentUser.id = null;
                navNameEl.innerText = 'Partner';
                accountNameEl.innerText = 'Guest User';
                accountIdEl.innerText = '—';
                accountProfileEl.innerText = 'Not Linked';
                return;
            }

            const {
                id,
                userId,
                user_id,
                companyProfileId,
                company_profile_id,
                companyId,
                company_id,
                firstName,
                lastName,
                brandName,
                companyName,
                username
            } = parsedUser;

            currentUser.id = id || userId || user_id || parsedUser.user?.id || currentUser.id || null;

            const displayName = [firstName, lastName].filter(Boolean).join(' ') || brandName || companyName || username || 'Company User';
            const displayCompany = brandName || companyName || 'Company Account';
            const resolvedProfileId = companyProfileId || company_profile_id || parsedUser.profileId || parsedUser.company_profile_id || companyId || company_id || currentUser.companyProfileId || null;

            if (navNameEl) {
                navNameEl.innerText = displayCompany;
            }
            if (accountNameEl) {
                accountNameEl.innerText = displayName;
            }
            if (accountIdEl) {
                accountIdEl.innerText = currentUser.id ? `#${currentUser.id}` : '—';
            }
            if (accountProfileEl) {
                if (resolvedProfileId) {
                    const userSuffix = currentUser.id ? ` • User #${currentUser.id}` : '';
                    accountProfileEl.innerText = `ID ${resolvedProfileId}${userSuffix}`;
                } else {
                    accountProfileEl.innerText = 'Not Linked';
                }
            }
            currentUser.companyProfileId = resolvedProfileId || currentUser.companyProfileId || null;
            if (resolvedProfileId) {
                const companyProfileInput = document.getElementById('companyProfileId');
                if (companyProfileInput && !companyProfileInput.value) {
                    companyProfileInput.value = resolvedProfileId;
                }
            }

            console.info('Account snapshot hydrated', {
                userId: currentUser.id,
                    companyProfileId: currentUser.companyProfileId,
                    source: storedContext?.source || 'hydrateAccountSummary'
            });
        }

        async function fetchCompanyProfileIfNeeded(force = false) {
            if (companyProfileFetchAttempted && !force) {
                return;
            }

            const authHeader = getStoredAuthToken();
            if (!authHeader) {
                console.warn('Company profile fetch skipped: no auth token found');
                return;
            }

            companyProfileFetchAttempted = true;

            try {
                console.debug('Requesting company profile...');
                const response = await fetch(`${API_BASE}/api/company-registration/profile`, {
                    headers: {
                        'Authorization': authHeader,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.warn('Company profile request failed', response.status, response.statusText);
                    companyProfileFetchAttempted = false;
                    return;
                }

                const payload = await response.json();
                if (!payload?.success || !payload?.company) {
                    console.warn('Company profile payload missing expected data', payload);
                    companyProfileFetchAttempted = false;
                    return;
                }

                const companyProfileInput = document.getElementById('companyProfileId');
                const profileId = payload.company.company_id || null;
                const userId = payload.company.user_id || null;

                console.info('Company profile resolved', {
                    companyProfileId: profileId,
                    userId,
                    company: payload.company
                });

                if (profileId && companyProfileInput) {
                    companyProfileInput.value = profileId;
                }
                if (profileId) {
                    currentUser.companyProfileId = profileId;
                    sessionStorage.setItem('companyProfileId', profileId);
                    localStorage.setItem('companyProfileId', profileId);
                }

                if (userId) {
                    currentUser.id = userId;
                    sessionStorage.setItem('companyUserId', userId);
                    localStorage.setItem('companyUserId', userId);
                    const accountIdEl = document.getElementById('accountId');
                    if (accountIdEl) {
                        accountIdEl.innerText = `#${userId}`;
                    }
                }

                try {
                    sessionStorage.setItem('companyProfilePayload', JSON.stringify(payload.company));
                    localStorage.setItem('companyProfilePayload', JSON.stringify(payload.company));
                } catch (error) {
                    console.warn('Unable to persist company payload', error);
                }

                if (payload.company.brand_name) {
                    const navNameEl = document.getElementById('navCompanyName');
                    if (navNameEl) {
                        navNameEl.innerText = payload.company.brand_name;
                    }
                }

                if (payload.company.company_name) {
                    const accountNameEl = document.getElementById('accountName');
                    if (accountNameEl) {
                        accountNameEl.innerText = payload.company.company_name;
                    }
                }

                if (profileId) {
                    const accountProfileEl = document.getElementById('accountProfile');
                    if (accountProfileEl) {
                        const userSuffix = userId ? ` • User #${userId}` : '';
                        accountProfileEl.innerText = `ID ${profileId}${userSuffix}`;
                    }
                }

                hydrateAccountSummary();
            } catch (error) {
                console.warn('Unable to fetch company profile', error);
                companyProfileFetchAttempted = false;
            }
        }

        function saveSettings() {
            apiKey = document.getElementById('apiKeyInput').value.trim();
            localStorage.setItem('meshy_api_key', apiKey);
            toggleSettings();
        }

        function initBackgroundPicker() {
            document.querySelectorAll('[data-background]').forEach((button) => {
                button.addEventListener('click', () => {
                    setViewerBackground(button.getAttribute('data-background'));
                });
            });
        }

        function setViewerBackground(id) {
            const option = BACKGROUND_OPTIONS[id] || BACKGROUND_OPTIONS.midnight;
            activeBackground = option === BACKGROUND_OPTIONS[id] ? id : 'midnight';
            const viewerWrapper = document.getElementById('viewer-wrapper');
            const viewer = document.getElementById('modelViewer');
            if (viewerWrapper) {
                viewerWrapper.style.background = option.wrapperBackground;
            }
            if (viewer) {
                viewer.style.background = option.viewerBackground;
                viewer.style.backgroundColor = option.viewerBackground === 'transparent' ? 'transparent' : option.viewerBackground;
                viewer.setAttribute('environment-image', option.environment);
                viewer.setAttribute('exposure', option.exposure);
            }
            document.querySelectorAll('[data-background]').forEach((btn) => {
                btn.classList.toggle('active', btn.getAttribute('data-background') === activeBackground);
            });
        }

        function setGenerateButtonState(state) {
            if (!generateBtn) return;
            if (state === 'loading') {
                generateBtn.disabled = true;
                generateBtn.className = `${generateBtnDefaultClass} btn-loading`;
                generateBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Generating<span class="loading-dots"><span></span><span></span><span></span></span>';
                return;
            }
            if (state === 'completed') {
                generateBtn.disabled = false;
                generateBtn.className = 'btn-modern w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl text-sm font-semibold tracking-wide flex items-center justify-center gap-2';
                generateBtn.innerHTML = '<i class="fa-solid fa-check"></i> Completed';
                return;
            }
            generateBtn.disabled = false;
            generateBtn.className = generateBtnDefaultClass;
            generateBtn.innerHTML = generateBtnDefaultHTML;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                uploadedImageBase64 = ev.target.result;
                document.getElementById('previewImg').src = uploadedImageBase64;
                document.getElementById('uploadPrompt').classList.add('hidden');
                document.getElementById('imagePreview').classList.remove('hidden');
                document.getElementById('step-config').classList.remove('opacity-50', 'pointer-events-none');
            };
            reader.readAsDataURL(file);
        }

        function resetUpload(event) {
            event.stopPropagation();
            uploadedImageBase64 = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('uploadPrompt').classList.remove('hidden');
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('step-config').classList.add('opacity-50', 'pointer-events-none');
            currentUrls = { glb: null, obj: null, proxy: null, thumbnail: null };
            currentLocalPaths = {};
            setGenerateButtonState('default');
        }

        async function startGeneration() {
            if (!apiKey) {
                toggleSettings();
                return showToast('Enter your Meshy API key first.', 'error');
            }
            if (!uploadedImageBase64) {
                return showToast('Upload a reference image to begin.', 'error');
            }
            setGenerateButtonState('loading');
            document.getElementById('consoleSection').classList.remove('hidden');
            const payload = {
                image_url: uploadedImageBase64,
                enable_pbr: true,
                should_remesh: true,
                should_texture: true,
                texture_prompt: document.getElementById('texturePrompt').value || undefined,
                negative_prompt: document.getElementById('negativePrompt').value || undefined,
                style: document.getElementById('artStyle').value,
                target_polycount: document.getElementById('polyCount').value === 'high' ? 50000 : 30000
            };
            log('Submitting to Meshy...');
            try {
                const response = await fetch('https://api.meshy.ai/openapi/v1/image-to-3d', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'Meshy API error');
                }
                currentTaskId = data.result;
                pollStatus();
            } catch (error) {
                setGenerateButtonState('default');
                showToast(error.message || 'Unable to start generation.', 'error');
            }
        }

        async function pollStatus() {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`https://api.meshy.ai/openapi/v1/image-to-3d/${currentTaskId}`, {
                        headers: { 'Authorization': `Bearer ${apiKey}` }
                    });
                    const data = await response.json();
                    const progress = data.progress || 0;
                    document.getElementById('progressBar').style.width = `${progress}%`;
                    document.getElementById('progressText').innerText = `${progress}%`;
                    log(`Status: ${data.status}`);
                    if (data.status === 'SUCCEEDED') {
                        clearInterval(interval);
                        handleSuccess(data);
                    }
                    if (data.status === 'FAILED') {
                        clearInterval(interval);
                        setGenerateButtonState('default');
                        showToast('Generation failed. Try a clearer image.', 'error');
                    }
                } catch (error) {
                    clearInterval(interval);
                    setGenerateButtonState('default');
                    showToast('Unable to check Meshy status.', 'error');
                }
            }, 2500);
        }

        function handleSuccess(data) {
            currentUrls.glb = data.model_urls?.glb || null;
            currentUrls.obj = data.model_urls?.obj || null;
            currentUrls.thumbnail = data.thumbnail_url || null;
            currentUrls.proxy = currentUrls.glb ? `${API_BASE}/api/proxy-model?url=${encodeURIComponent(currentUrls.glb)}` : null;
            currentLocalPaths = {};
            const viewer = document.getElementById('modelViewer');
            viewer.src = currentUrls.proxy || currentUrls.glb;
            viewer.addEventListener('error', () => {
                if (currentUrls.glb && viewer.src !== currentUrls.glb) {
                    viewer.src = currentUrls.glb;
                }
            }, { once: true });
            setViewerBackground(activeBackground);
            document.getElementById('canvas-placeholder').classList.add('hidden');
            document.getElementById('viewer-wrapper').classList.remove('opacity-0');
            document.getElementById('step-save').classList.remove('hidden');
            setGenerateButtonState('completed');
            showToast('3D asset ready. Complete product details to publish.', 'info');
        }

        async function saveToCompanyLibrary(event) {
            event.preventDefault();
            const button = event.currentTarget;
            const defaultHtml = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving';
            try {
                const companyProfileId = parseInt(document.getElementById('companyProfileId').value, 10);
                if (!companyProfileId) {
                    throw new Error('Company profile ID is required.');
                }
                const payload = {
                    companyProfileId,
                    taskId: currentTaskId || `manual-${Date.now()}`,
                    name: document.getElementById('modelName').value.trim() || 'Untitled Asset',
                    description: document.getElementById('dbDesc').value.trim() || null,
                    category: document.getElementById('dbCategory').value,
                    style: document.getElementById('dbStyle').value,
                    price: parseFloat(document.getElementById('dbPrice').value) || null,
                    wholesalePrice: parseFloat(document.getElementById('dbWholesale').value) || null,
                    msrp: parseFloat(document.getElementById('dbMsrp').value) || null,
                    sku: document.getElementById('dbSku').value.trim() || null,
                    inventory: parseInt(document.getElementById('dbInventory').value, 10) || null,
                    leadTimeDays: parseInt(document.getElementById('dbLeadTime').value, 10) || null,
                    materials: document.getElementById('dbMaterials').value.trim() || null,
                    finishes: document.getElementById('dbFinishes').value.trim() || null,
                    modelUrl: currentUrls.glb,
                    previewUrl: currentUrls.thumbnail,
                    imageUrl: currentUrls.thumbnail,
                    downloadUrl: currentUrls.glb,
                    modelUrls: {
                        glb: currentUrls.glb,
                        obj: currentUrls.obj,
                        proxy: currentUrls.proxy,
                        thumbnail: currentUrls.thumbnail
                    },
                    submittedByUserId: currentUser.id
                };
                const headers = { 'Content-Type': 'application/json' };
                const storedToken = getStoredAuthToken();
                if (storedToken) {
                    headers['Authorization'] = storedToken;
                }
                const response = await fetch(`${API_BASE}/api/company-models/save`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(payload)
                });
                const body = await response.json().catch(() => ({}));
                if (!response.ok || body.success === false) {
                    throw new Error(body.message || 'Unable to save asset.');
                }
                currentLocalPaths = body.localUrls || {};
                button.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
                showToast(body.message || 'Model saved to company library.', 'success');
            } catch (error) {
                button.innerHTML = defaultHtml;
                showToast(error.message || 'Save failed. Please retry.', 'error');
            } finally {
                button.disabled = false;
            }
        }

        function downloadModel() {
            const link = document.createElement('a');
            const localPath = currentLocalPaths.glb || null;
            if (localPath) {
                const resolved = localPath.startsWith('http') ? localPath : `${API_BASE}${localPath.startsWith('/') ? localPath : `/${localPath}`}`;
                link.href = resolved;
                link.download = `${document.getElementById('modelName').value || 'model'}.glb`;
                link.click();
                return;
            }
            if (currentUrls.obj) {
                link.href = currentUrls.obj;
                link.download = `${document.getElementById('modelName').value || 'model'}.obj`;
                link.click();
                return;
            }
            if (currentUrls.glb) {
                link.href = `${API_BASE}/api/download/${currentTaskId}?url=${encodeURIComponent(currentUrls.glb)}`;
                link.download = `${document.getElementById('modelName').value || 'model'}.glb`;
                link.click();
                return;
            }
            showToast('Model file not available yet.', 'error');
        }

        function toggleRotate() {
            const viewer = document.getElementById('modelViewer');
            viewer.hasAttribute('auto-rotate') ? viewer.removeAttribute('auto-rotate') : viewer.setAttribute('auto-rotate', '');
        }

        function log(message) {
            const area = document.getElementById('consoleArea');
            area.innerHTML += `<div>> ${message}</div>`;
            area.scrollTop = area.scrollHeight;
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const baseClass = 'px-4 py-3 rounded-xl shadow-lg backdrop-blur text-white text-xs font-semibold border border-white/10';
            const palette = {
                success: 'bg-emerald-500/90',
                error: 'bg-rose-500/90',
                info: 'bg-sky-500/90'
            };
            toast.className = `${baseClass} ${palette[type] || palette.success}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3200);
        }
    </script>
</body>
</html>
