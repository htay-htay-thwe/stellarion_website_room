<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Room Layout | Stellarion Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            color-scheme: dark;
            --bg: #020617;
            --panel: rgba(15, 23, 42, 0.85);
            --border: rgba(148, 163, 184, 0.2);
            --accent: #6366f1;
            --success: #34d399;
            --danger: #f87171;
            --text: #e2e8f0;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Plus Jakarta Sans', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            background: radial-gradient(circle at 20% -10%, rgba(99, 102, 241, 0.25), transparent 60%),
                radial-gradient(circle at 80% 10%, rgba(56, 189, 248, 0.3), transparent 65%),
                var(--bg);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 16px;
        }

        main {
            width: min(1100px, 100%);
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 28px;
            padding: 32px clamp(20px, 4vw, 48px);
            box-shadow: 0 30px 80px -40px rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(18px);
        }

        header {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .brand img {
            width: 44px;
            height: 44px;
            border-radius: 12px;
        }

        .brand h1 {
            margin: 0;
            font-size: 1.4rem;
            letter-spacing: 0.06rem;
        }

        .share-code {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .share-code button {
            background: none;
            border: none;
            color: rgba(226, 232, 240, 0.95);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .status-bar {
            margin-bottom: 24px;
            font-size: 0.9rem;
            padding: 12px 18px;
            border-radius: 14px;
            background: rgba(148, 163, 184, 0.14);
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .status-bar.error {
            background: rgba(248, 113, 113, 0.16);
            border-color: rgba(248, 113, 113, 0.35);
            color: #fecaca;
        }

        .status-bar.success {
            background: rgba(52, 211, 153, 0.16);
            border-color: rgba(52, 211, 153, 0.3);
            color: #dcfce7;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
            margin-bottom: 28px;
        }

        .card {
            background: rgba(15, 23, 42, 0.78);
            border: 1px solid rgba(99, 102, 241, 0.12);
            border-radius: 18px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .card h2 {
            margin: 0 0 6px;
            font-size: 0.95rem;
            letter-spacing: 0.08rem;
            text-transform: uppercase;
            color: rgba(191, 219, 254, 0.85);
        }

        .card p {
            margin: 0;
            font-size: 0.9rem;
            color: rgba(226, 232, 240, 0.85);
        }

        .card p strong {
            color: rgba(244, 244, 255, 0.95);
        }

        .assets-section {
            margin-top: 28px;
        }

        .assets-header {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .assets-header h2 {
            margin: 0;
            font-size: 1rem;
            letter-spacing: 0.08rem;
            text-transform: uppercase;
            color: rgba(191, 219, 254, 0.85);
        }

        .asset-list {
            display: grid;
            gap: 12px;
        }

        .asset-card {
            background: rgba(11, 18, 33, 0.85);
            border: 1px solid rgba(99, 102, 241, 0.12);
            border-radius: 16px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .asset-card h3 {
            margin: 0;
            font-size: 0.95rem;
            color: rgba(244, 244, 255, 0.92);
            letter-spacing: 0.02rem;
        }

        .asset-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            font-size: 0.78rem;
            color: rgba(203, 213, 225, 0.75);
        }

        .asset-meta span {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            border-radius: 18px;
            border: 1px dashed rgba(148, 163, 184, 0.35);
            color: rgba(148, 163, 184, 0.9);
            background: rgba(15, 23, 42, 0.6);
        }

        button.primary {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.95), rgba(14, 165, 233, 0.95));
            color: #fff;
            border: none;
            border-radius: 12px;
            padding: 10px 18px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.18s ease;
        }

        button.primary:hover {
            transform: translateY(-1px);
        }

        .input-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 18px;
        }

        .input-group input {
            flex: 1;
            min-width: 220px;
            background: rgba(15, 23, 42, 0.65);
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 12px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 0.9rem;
        }

        @media (max-width: 640px) {
            header {
                flex-direction: column;
                align-items: flex-start;
            }
            .share-code {
                width: 100%;
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <main>
        <header>
            <div class="brand">
                <img src="assets/logo/logo/stellarion-rounded.png" alt="Stellarion Studio logo" onerror="this.src='assets/logo/logo/stellarion.png'">
                <h1>Shared Room Layout Package</h1>
            </div>
            <div class="share-code" id="shareCodeBadge" hidden>
                <span id="shareCodeLabel">Share Code</span>
                <button type="button" id="copyShareBtn" title="Copy share details">
                    <i class="fa-solid fa-copy"></i>
                </button>
            </div>
        </header>

        <div class="status-bar" id="statusBar">Loading share package…</div>

        <section class="input-group" id="fallbackInput" hidden>
            <input type="text" id="shareInput" placeholder="Enter share code" maxlength="32" autocomplete="off">
            <button type="button" class="primary" id="loadShareBtn">Load Layout</button>
        </section>

        <section class="card-grid" id="metaGrid" hidden>
            <article class="card">
                <h2>Client Contact</h2>
                <p><strong id="contactName">—</strong></p>
                <p id="contactEmail"></p>
                <p id="notesCopy"></p>
            </article>
            <article class="card">
                <h2>Relocation Partner</h2>
                <p><strong id="companyName">House Relocation Company</strong></p>
                <p id="shareSourceCopy"></p>
                <p id="requestedAt"></p>
            </article>
            <article class="card">
                <h2>Room Summary</h2>
                <p id="roomName">—</p>
                <p id="environmentCopy"></p>
                <p id="lightingCopy"></p>
            </article>
        </section>

        <section class="assets-section" id="assetsSection" hidden>
            <div class="assets-header">
                <h2>Placed Furnishings &amp; Fixtures</h2>
                <span id="assetCount"></span>
            </div>
            <div class="asset-list" id="assetList"></div>
        </section>

        <div class="empty-state" id="emptyState" hidden>
            Provide a share code above to review the latest room layout package.
        </div>
    </main>

    <script>
        const statusBar = document.getElementById('statusBar');
        const shareCodeBadge = document.getElementById('shareCodeBadge');
        const shareCodeLabel = document.getElementById('shareCodeLabel');
        const copyShareBtn = document.getElementById('copyShareBtn');
        const fallbackInput = document.getElementById('fallbackInput');
        const shareInput = document.getElementById('shareInput');
        const loadShareBtn = document.getElementById('loadShareBtn');
        const metaGrid = document.getElementById('metaGrid');
        const assetsSection = document.getElementById('assetsSection');
        const assetList = document.getElementById('assetList');
        const assetCount = document.getElementById('assetCount');
        const emptyState = document.getElementById('emptyState');
        const contactName = document.getElementById('contactName');
        const contactEmail = document.getElementById('contactEmail');
        const notesCopy = document.getElementById('notesCopy');
        const companyName = document.getElementById('companyName');
        const shareSourceCopy = document.getElementById('shareSourceCopy');
        const requestedAt = document.getElementById('requestedAt');
        const roomName = document.getElementById('roomName');
        const environmentCopy = document.getElementById('environmentCopy');
        const lightingCopy = document.getElementById('lightingCopy');

        const API_BASE = window.location.origin.includes('localhost') ? 'http://localhost:3000' : window.location.origin;
        const SHARE_IMPORT_STORAGE_KEY = 'stellarionSharedLayoutImport';
        let activeShare = null;

        const normalizeShareCode = (value) => {
            if (!value) return '';
            return value.toString().trim().toUpperCase().replace(/[^A-Z0-9]/g, '');
        };

        const buildShareLink = (code) => `${window.location.origin}/room-share.html?code=${encodeURIComponent(code)}`;

        const setLoadButtonMode = (mode) => {
            if (!loadShareBtn) return;
            if (mode === 'import') {
                loadShareBtn.textContent = 'Open in Setup';
                loadShareBtn.dataset.mode = 'import';
            } else {
                loadShareBtn.textContent = 'Load Layout';
                loadShareBtn.dataset.mode = 'fetch';
            }
        };

        const prepareLayoutImport = () => {
            if (!activeShare || !activeShare.payload || !activeShare.payload.snapshot) {
                setStatus('Load a share package before opening it in the editor.', 'error');
                return;
            }
            try {
                const payload = {
                    code: activeShare.code,
                    snapshot: activeShare.payload.snapshot,
                    metadata: {
                        contactName: activeShare.payload.contactName || null,
                        contactEmail: activeShare.payload.contactEmail || null,
                        companyName: activeShare.payload.companyName || null,
                        roomName: (activeShare.payload.snapshot && activeShare.payload.snapshot.room && activeShare.payload.snapshot.room.name)
                            || activeShare.payload.roomName
                            || null,
                        createdAt: activeShare.payload.createdAt || null
                    }
                };
                localStorage.setItem(SHARE_IMPORT_STORAGE_KEY, JSON.stringify(payload));
            } catch (error) {
                console.error('Unable to store layout import payload', error);
                setStatus('Unable to prepare layout import (storage not available).', 'error');
                return;
            }
            setStatus('Opening layout in editor…', 'success');
            window.location.href = 'setup_myroom.html';
        };

        const setStatus = (message, tone = 'info') => {
            statusBar.textContent = message;
            statusBar.classList.remove('error', 'success');
            if (tone === 'error') {
                statusBar.classList.add('error');
            } else if (tone === 'success') {
                statusBar.classList.add('success');
            }
        };

        const formatDate = (value) => {
            if (!value) return null;
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return null;
            return date.toLocaleString(undefined, {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
        };

        const summarizeLighting = (lighting) => {
            if (!lighting) return 'Lighting details unavailable.';
            const brightness = Number.isFinite(lighting.brightnessPercent) ? `${lighting.brightnessPercent}% brightness` : 'Custom brightness';
            const extras = lighting.extraLightsEnabled ? 'Extra accent lighting enabled' : 'Only base lighting active';
            return `${brightness}. ${extras}.`;
        };

        const renderAssets = (assets = []) => {
            assetList.innerHTML = '';
            if (!Array.isArray(assets) || assets.length === 0) {
                assetsSection.hidden = true;
                assetCount.textContent = '';
                return;
            }
            assetsSection.hidden = false;
            assets.forEach((asset, index) => {
                const card = document.createElement('div');
                card.className = 'asset-card';

                const title = document.createElement('h3');
                title.textContent = asset?.name || `Asset ${index + 1}`;
                card.appendChild(title);

                const meta = document.createElement('div');
                meta.className = 'asset-meta';

                const source = asset?.librarySource || asset?.source || 'Custom';
                meta.appendChild(createMetaChip('fa-warehouse', source));

                if (asset?.category) {
                    meta.appendChild(createMetaChip('fa-tags', asset.category));
                }

                if (Number.isFinite(asset?.price)) {
                    meta.appendChild(createMetaChip('fa-dollar-sign', new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(asset.price)));
                }

                meta.appendChild(createMetaChip('fa-location-dot', formatVector(asset?.position)));
                meta.appendChild(createMetaChip('fa-arrows-rotate', formatVector(asset?.rotationDeg)));
                meta.appendChild(createMetaChip('fa-expand', formatVector(asset?.scale)));

                card.appendChild(meta);
                assetList.appendChild(card);
            });
            assetCount.textContent = `${assets.length} item${assets.length === 1 ? '' : 's'} placed`;
        };

        const createMetaChip = (icon, text) => {
            const span = document.createElement('span');
            const iconEl = document.createElement('i');
            iconEl.className = `fa-solid ${icon}`;
            span.appendChild(iconEl);
            const textEl = document.createElement('span');
            textEl.textContent = text || '—';
            span.appendChild(textEl);
            return span;
        };

        const formatVector = (vector) => {
            if (!Array.isArray(vector)) return '—';
            return vector.map(value => {
                if (!Number.isFinite(value)) return '—';
                return value.toFixed(2);
            }).join(', ');
        };

        const populateMeta = ({ data }) => {
            if (!data) return;
            contactName.textContent = data.contactName || 'Client name not provided';
            contactEmail.innerHTML = data.contactEmail
                ? `<i class="fa-solid fa-envelope"></i> ${data.contactEmail}`
                : 'No email supplied';
            notesCopy.textContent = data.notes ? `Notes: ${data.notes}` : 'No relocation notes supplied yet.';

            companyName.textContent = data.companyName || 'House Relocation Company';
            shareSourceCopy.textContent = data.shareSource ? `Shared from ${data.shareSource}` : 'Shared via Stellarion Setup My Room';
            requestedAt.textContent = formatDate(data.createdAt) ? `Submitted on ${formatDate(data.createdAt)}` : '';

            const roomInfo = data.snapshot?.room;
            roomName.textContent = roomInfo?.name || 'Room name not captured';
            environmentCopy.textContent = data.snapshot?.environment
                ? `Background: ${data.snapshot.environment}`
                : 'Background environment not specified.';
            lightingCopy.textContent = summarizeLighting(data.snapshot?.lighting);

            renderAssets(Array.isArray(data.snapshot?.assets) ? data.snapshot.assets : []);
        };

        const setShareCodeBadge = (code) => {
            if (!code) {
                shareCodeBadge.hidden = true;
                return;
            }
            shareCodeLabel.textContent = code;
            shareCodeBadge.hidden = false;
        };

        const handleCopyShare = async (dataset) => {
            const lines = [
                `Share Code: ${dataset.shareCode}`,
                `Link: ${dataset.shareLink}`
            ];
            if (!navigator.clipboard || typeof navigator.clipboard.writeText !== 'function') {
                setStatus('Clipboard not available. Copy manually.', 'error');
                return;
            }
            try {
                await navigator.clipboard.writeText(lines.join('\n'));
                setStatus('Share details copied to clipboard.', 'success');
            } catch (error) {
                console.warn('Clipboard copy failed', error);
                setStatus('Unable to copy share details. Please copy manually.', 'error');
            }
        };

        const fetchShare = async (code) => {
            if (!code) {
                setStatus('Provide a share code to view the layout package.', 'info');
                metaGrid.hidden = true;
                assetsSection.hidden = true;
                emptyState.hidden = false;
                activeShare = null;
                setLoadButtonMode('fetch');
                return;
            }

            setStatus('Loading share package…');
            activeShare = null;
            setLoadButtonMode('fetch');
            try {
                const response = await fetch(`${API_BASE}/api/room-share/${encodeURIComponent(code)}`);
                const body = await response.json().catch(() => null);
                if (!response.ok) {
                    const message = body?.message || `Share request failed (${response.status})`;
                    throw new Error(message);
                }
                setStatus('Layout package ready.', 'success');
                metaGrid.hidden = false;
                emptyState.hidden = true;
                populateMeta(body);
                const shareLink = buildShareLink(code);
                copyShareBtn.dataset.shareCode = code;
                copyShareBtn.dataset.shareLink = shareLink;
                setShareCodeBadge(code);
                const shareData = body?.data || null;
                if (shareData && shareData.snapshot) {
                    activeShare = {
                        code,
                        payload: shareData
                    };
                    setLoadButtonMode('import');
                } else {
                    activeShare = null;
                    setLoadButtonMode('fetch');
                    setStatus('Layout details unavailable in this share package.', 'info');
                }
            } catch (error) {
                console.error('Share fetch failed:', error);
                setStatus(error.message || 'Unable to load share package right now.', 'error');
                metaGrid.hidden = true;
                assetsSection.hidden = true;
                emptyState.hidden = false;
                setShareCodeBadge(null);
                delete copyShareBtn.dataset.shareCode;
                delete copyShareBtn.dataset.shareLink;
                activeShare = null;
                setLoadButtonMode('fetch');
            }
        };

        const determineInitialCode = () => {
            const params = new URLSearchParams(window.location.search);
            const fromQuery = normalizeShareCode(params.get('code'));
            if (fromQuery) return fromQuery;
            const parts = window.location.pathname.split('/').filter(Boolean);
            const roomShareIndex = parts.findIndex(part => part.toLowerCase() === 'room-share');
            if (roomShareIndex >= 0 && parts.length > roomShareIndex + 1) {
                return normalizeShareCode(parts[roomShareIndex + 1]);
            }
            return '';
        };

        const init = () => {
            setLoadButtonMode('fetch');
            const shareCode = determineInitialCode();
            if (!shareCode) {
                fallbackInput.hidden = false;
                emptyState.hidden = false;
                setStatus('Enter a share code below to load the shared layout.');
                return;
            }
            shareInput.value = shareCode;
            fallbackInput.hidden = false;
            fetchShare(shareCode);
        };

        loadShareBtn.addEventListener('click', () => {
            const code = normalizeShareCode(shareInput.value);
            if (!code) {
                setStatus('Please enter a share code to continue.', 'error');
                return;
            }

            if (loadShareBtn.dataset.mode === 'import' && activeShare && activeShare.code === code) {
                prepareLayoutImport();
                return;
            }

            const nextUrl = buildShareLink(code);
            if (window.location.href !== nextUrl) {
                window.history.replaceState({}, '', nextUrl);
            }
            fetchShare(code);
        });

        shareInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                loadShareBtn.click();
            }
        });

        shareInput.addEventListener('input', () => {
            activeShare = null;
            setLoadButtonMode('fetch');
        });

        copyShareBtn.addEventListener('click', () => {
            const { shareCode, shareLink } = copyShareBtn.dataset;
            if (!shareCode || !shareLink) {
                setStatus('Share details unavailable yet.', 'error');
                return;
            }
            handleCopyShare({ shareCode, shareLink });
        });

        init();
    </script>
</body>
</html>
